let data,chart,selected={code:"",fill:""};const COLORS={default:"#cccccc",bar:"#5cd",line:"#fc3",netflow:[[null,-1e3,"#2166AC"],[-1e3,-500,"#4393C3"],[-500,-50,"#92C5DE"],[-50,0,"#D1E5F0"],[0,50,"#FDDBC7"],[50,500,"#F4A582"],[500,1e3,"#D6604D"],[1e3,null,"#B2182B"]],growth:[[null,1,"#f4f2fd"],[1,5,"#bdc3d3"],[5,10,"#8497aa"],[10,50,"#4a6e7f"],[50,null,"#034752"]]},UNIT={netflow:"百万円",growth:"倍"},init=()=>{const t=(t,e)=>{let a=0;return"netflow"===e&&(a=t[24]-t[26]),"growth"===e&&(a=0===t[14]?"-":t[24]/t[14]),a},e=()=>{$("#map").find("path").each(function(){let e=$(this).attr("code"),a=(e=>{let a=COLORS.default;if(e){let o=$("#switch").find(".switch-item.selected").attr("code"),n=t(e,o);"netflow"===o&&(n/=1e3);let i=COLORS[o].filter(t=>(null===t[0]||t[0]<=n)&&(n<=t[1]||null===t[1]));a=i[0]?i[0][2]:"#cccccc"}return a})(data[e]);$(this).attr("fill",a)}),selected={code:"",fill:""}},a=t=>String(t).replace(/(\d)(?=(\d\d\d)+(?!\d))/g,"$1,");(()=>{let o=$("#map").width(),n=$("#map").height();$("#map").empty();let i=d3.geoMercator();i=d3.geoMercator().center([138,37]).translate([o/2,n/2]).scale(4e3);let l=d3.select("#map"),s=d3.geoPath().projection(i),r=l.append("g");d3.json(["https://raw.githubusercontent.com/smartnews-smri/japan-topography/main/data/municipality/topojson/s0010/N03-21_210101_designated_city.json"]).then(function(o){const n=topojson.feature(o,o.objects["N03-21_210101"]);r.selectAll("path").data(n.features).enter().append("path").attr("d",s).attr("fill",$("#input-default-color").val()).attr("code",function(t){return t.properties.N03_007}).on("click tap touch",function(e,o){data[e.properties.N03_007]?(""!=selected.code&&$("#map").find("path[code='"+selected.code+"']").attr("fill",selected.fill),selected.code=d3.select(this).attr("code"),selected.fill=d3.select(this).attr("fill"),d3.select(this).attr("fill","yellow"),(e=>{let o=e.N03_001;e.N03_003&&(o+=" "+e.N03_003),e.N03_004&&(o+=" "+e.N03_004),$("#info-content").find("h3").text(o);let n=data[e.N03_007],i=t(n,"netflow"),l=t(n,"growth");l="-"==l?"-":a(Number.parseFloat(l).toFixed(1)),$("#info-table-inflow").text(a(n[24])),$("#info-table-outflow").text(a(n[26])),$("#info-table-netflow").text(a(i)),$("#info-table-growth").text(l),(t=>{let e=[[],[]],a=[[],[]];for(let o=0;o<=24;o+=2)e[0].push(t[o+1]),e[1].push(t[o]),a[1].push(COLORS.bar);chart.config.data.datasets[0].data=e[0],chart.config.data.datasets[1].data=e[1],chart.config.data.datasets[0].backgroundColor=a[0],chart.config.data.datasets[1].backgroundColor=a[1],chart.update()})(n),$("#info").addClass("show")})(e.properties)):$("#info").removeClass("show")}),d3.json("./data/data.json").then(function(t){data=t,e(),$("#title").removeClass("hide"),$("#buttons").removeClass("hide"),$("#switch").removeClass("hide")})});let c=d3.zoom().scaleExtent([.3,100]).on("zoom",function(){r.selectAll("path").attr("transform",d3.event.transform)});l.transition().duration(0).call(c.transform,d3.zoomIdentity),l.call(c)})(),(()=>{const t=t=>{let e=a(t);return parseInt(t)>=1e4&&(e=(parseInt(t)/1e4).toString()+"万"),parseInt(t)>=1e8&&(e=(parseInt(t)/1e8).toString()+"億"),parseInt(t)<=-1e4&&(e=(parseInt(t)/1e4).toString()+"万"),parseInt(t)<=-1e8&&(e=(parseInt(t)/1e8).toString()+"億"),e};let e=$("#info-chart").empty().html("<canvas></canvas>"),o=e.find("canvas")[0],n={type:"bar",data:{labels:["2008","2009","2010","2011","2012","2013","2014","2015","2016","2017","2018","2019","2020"],datasets:[{label:"寄付件数",type:"line",backgroundColor:[],fill:!1,borderColor:COLORS.line,borderWidth:4,pointRadius:0,pointStyle:"line",yAxisID:"y-axis-2",data:[]},{label:"寄付額",backgroundColor:[],borderColor:"transparent",yAxisID:"y-axis-1",data:[]}]},options:{aspectRatio:(t=>{let e=1.6;return 400<=t.innerWidth()&&(e=2),e})(e),animation:{duration:450},layout:{padding:{top:0}},interaction:{mode:"index"},elements:{line:{tension:.1}},legend:{display:!0,reverse:!0,labels:{usePointStyle:!0,fontColor:"rgba(255, 255, 255, 0.7)"}},title:{display:!1},tooltips:{xPadding:24,yPadding:12,displayColors:!1,callbacks:{title:function(t){return t[0].xLabel.trim()+"年度"},label:function(t,e){let o=[];return e.datasets.map((e,n)=>{let i=e.label+": "+a(e.data[t.index])+" "+["件","千円"][n];o.unshift(i)}),o}}},scales:{xAxes:[{stacked:!0,gridLines:{display:!1,zeroLineColor:"rgba(255,255,255,0.2)"},ticks:{fontColor:"rgba(255, 255, 255, 0.5)",maxRotation:0,minRotation:0,callback:t=>" "+t+" "}}],yAxes:[{id:"y-axis-1",type:"linear",position:"left",gridLines:{display:!0,zeroLineColor:"rgba(255,255,255,0.2)",borderDash:[3,1],color:"rgba(255,255,255,0.2)"},ticks:{beginAtZero:!0,fontColor:"rgba(255, 255, 255, 0.5)",maxTicksLimit:6,callback:e=>t(1e3*e)+"円"}},{id:"y-axis-2",type:"linear",position:"right",gridLines:{display:!1,zeroLineColor:"rgba(255,255,255,0.2)",borderDash:[3,1],color:"rgba(255,255,255,0.2)"},ticks:{beginAtZero:!0,fontColor:"rgba(255, 255, 255, 0.5)",maxTicksLimit:6,callback:e=>t(e)+"件"}}]}}};chart=new Chart(o.getContext("2d"),n),(()=>{let t=$("#info-content").outerWidth();$("#info-content").css("right","-"+t+"px")})()})(),$("#switch").find(".switch-item").each(function(){let t=$(this).attr("code");COLORS[t].map(function(e){let o="<tr><td>"+(null===e[0]?"":a(e[0])+"<span>"+UNIT[t]+"</span>")+"</td><td>〜</td><td>"+(null===e[1]?"":a(e[1])+"<span>"+UNIT[t]+"</span>")+'</td><td><div class="circle" style="background-color:'+e[2]+'"></div></td></tr>';$(".legend-table."+t).find("tbody").append(o)})}),$("#switch").find(".switch-item").on("click",function(){$(this).hasClass("selected")||($(this).siblings().removeClass("selected"),$(this).addClass("selected"),e())}),$("#info-button-close").on("click",function(){$("#info").removeClass("show")}),$("#intro-button").on("click",function(){$("#intro").addClass("show")}),$("#intro-button-show").on("click",function(){$("#intro").removeClass("show")}),$("#map").on("click",function(t){$(t.target).closest("path")[0]||$("#info").removeClass("show")}),$("#intro").on("click",function(t){$(t.target).closest("#intro-inner")[0]||$("#intro").removeClass("show")}),$("#intro").addClass("show")};$(function(){init()});